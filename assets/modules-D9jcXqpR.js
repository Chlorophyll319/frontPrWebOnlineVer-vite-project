import{k as S,l as X,m as p,n as Q,p as G,c as H,q as J,g as K,a as k,o as C,b as t,d as a,s as W,w as n,v as Y,f as g,x as $,t as f,e as Z,y as M,z as ee,A as se}from"./index-3je6mOWM.js";import{s as te,a as le,b as oe,d as ae,c as ie}from"./index-D9tgR56O.js";import{s as re}from"./index-DLIwkAuy.js";import{m as w}from"./modules-D68u6pAC.js";import{b as O}from"./route-block-B_A1xBdJ.js";import"./index-BZrE229p.js";const ne={class:"space-y-6"},de={class:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4"},ue={class:"flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-center"},me={class:"flex-1"},ce={class:"p-input-icon-left w-full"},pe={class:"sm:w-48"},ge={class:"font-medium line-clamp-2"},fe={class:"w-80 truncate"},be=["src","onClick"],ve={class:"flex items-center gap-2"},ye={class:"flex gap-2"},we={class:"rounded-xl bg-white/60 backdrop-blur p-4 space-y-4"},xe={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},_e={class:"col-span-1 md:col-span-2"},Ue={class:"col-span-1 md:col-span-2"},Ve={class:"col-span-1 md:col-span-2"},he={class:"col-span-1 md:col-span-2"},ke={class:"flex items-center gap-3"},Ce={class:"w-full flex items-center justify-between gap-3"},$e={__name:"modules",setup(Me){S();const d=X(),U=p([]),x=p(!1),b=p(""),v=p(null),u=p(!1),c=p(null),o=Q({title:"",description:"",category:"",imageUrl:"",sortOrder:0,visible:!0}),L=[{label:"上架",value:!0},{label:"下架",value:!1}],P=[{label:"前端基礎技術",value:"前端基礎技術"},{label:"前端框架與進階技術",value:"前端框架與進階技術"},{label:"後端開發與 API 串接",value:"後端開發與 API 串接"},{label:"資料庫設計與操作",value:"資料庫設計與操作"},{label:"版本控制與專案維運",value:"版本控制與專案維運"},{label:"UI/UX 設計",value:"UI/UX 設計"},{label:"作品製作與分享",value:"作品製作與分享"}];G(()=>{V()});const D=H(()=>{let l=U.value;if(b.value){const e=b.value.toLowerCase();l=l.filter(i=>(i.title||"").toLowerCase().includes(e)||(i.description||"").toLowerCase().includes(e)||(i.category||"").toLowerCase().includes(e))}return v.value!==null&&(l=l.filter(e=>e.visible===v.value)),[...l].sort((e,i)=>{const r=(e.sortOrder??0)-(i.sortOrder??0);return r!==0?r:new Date(i.createdAt)-new Date(e.createdAt)})});J(u,l=>{l||h()});const A=()=>{c.value=null,h(),u.value=!0},V=async()=>{x.value=!0;try{const{data:l}=await w.getAll();if(l.success)U.value=l.modules;else throw new Error(l.message||"從伺服器獲取模組資料失敗")}catch(l){const e=l.response?.data?.message||l.message||"無法取得模組資料";d.add({severity:"error",summary:"錯誤",detail:e,life:3e3})}finally{x.value=!1}},T=l=>l?"success":"secondary",h=()=>{Object.assign(o,{title:"",description:"",category:"",imageUrl:"",sortOrder:0,visible:!0})},j=l=>{l.imageUrl&&window.open(l.imageUrl,"_blank","noopener,noreferrer")},q=l=>{c.value=l,Object.assign(o,{...l}),u.value=!0},B=async()=>{if(!o.title?.trim()||!o.imageUrl?.trim()||!o.description?.trim()||!o.category?.trim()){d.add({severity:"warn",summary:"資料不足",detail:"請填寫所有必填欄位",life:2500});return}if(!(e=>{try{return new URL(e),!0}catch{return!1}})(o.imageUrl)){d.add({severity:"warn",summary:"格式錯誤",detail:"請提供正確的圖片網址格式",life:2500});return}if((o.title?.length||0)>100){d.add({severity:"warn",summary:"字數過長",detail:"標題最多 100 字",life:2500});return}if((o.description?.length||0)>300){d.add({severity:"warn",summary:"字數過長",detail:"描述最多 300 字",life:2500});return}try{if(c.value?._id){const{data:e}=await w.update(c.value._id,{...o});if(!e.success)throw new Error(e.message||"更新模組失敗");d.add({severity:"success",summary:"更新成功",detail:`模組「${o.title||"未命名"}」已更新`,life:3e3})}else{const{data:e}=await w.create({...o});if(!e.success)throw new Error(e.message||"新增模組失敗");d.add({severity:"success",summary:"新增成功",detail:`模組「${o.title||"未命名"}」已新增`,life:3e3})}u.value=!1,await V()}catch(e){const i=e.response?.data?.message||e.message||"操作失敗";d.add({severity:"error",summary:"儲存失敗",detail:i,life:3e3})}},I=async(l,e)=>{const i=l.visible;l.visible=e;try{const{data:r}=await w.update(l._id,{visible:e});if(!r.success)throw new Error(r.message||"更新狀態失敗");d.add({severity:"success",summary:"狀態已更新",detail:`「${l.title}」已${e?"上架":"下架"}`,life:2e3})}catch(r){l.visible=i;const y=r.response?.data?.message||r.message||"更新狀態失敗";d.add({severity:"error",summary:"更新失敗",detail:y,life:3e3})}};return(l,e)=>{const i=W,r=Y,y=re,m=le,R=oe,z=te,E=ie,F=se,N=K("ConfirmDialog");return C(),k("div",ne,[t("div",de,[e[11]||(e[11]=t("div",{class:"flex-1"},[t("h1",{class:"text-2xl sm:text-3xl font-bold text-gray-900"},"課程模組管理"),t("p",{class:"text-sm sm:text-base text-gray-600 mt-1 sm:mt-2"},"管理所有課程模組項目")],-1)),a(i,{label:"新增模組",icon:"pi pi-plus",severity:"primary",onClick:e[0]||(e[0]=s=>A()),id:"newModuleButton",size:"small",class:"w-full sm:w-auto"})]),a(y,{class:"shadow-sm"},{content:n(()=>[t("div",ue,[t("div",me,[e[12]||(e[12]=t("label",{for:"searchModules",class:"sr-only"},"搜尋模組",-1)),t("span",ce,[a(r,{id:"searchModules",name:"searchModules",modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=s=>b.value=s),modelModifiers:{trim:!0},placeholder:"搜尋標題、描述、分類...",class:"w-full"},null,8,["modelValue"])])]),t("div",pe,[a(g($),{id:"statusFilter",name:"statusFilter",modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=s=>v.value=s),options:L,optionLabel:"label",optionValue:"value",placeholder:"選擇狀態",showClear:"",class:"w-full"},null,8,["modelValue"])])])]),_:1}),a(y,{class:"shadow-sm"},{content:n(()=>[a(z,{loading:x.value,value:D.value,paginator:!0,rows:10,rowsPerPageOptions:[5,10,20,50],paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown",currentPageReportTemplate:"顯示第 {first} 到 {last} 項，共 {totalRecords} 項",responsiveLayout:"scroll",class:"p-datatable-sm"},{default:n(()=>[a(m,{field:"title",header:"標題",sortable:""},{body:n(({data:s})=>[t("div",ge,f(s.title),1)]),_:1}),a(m,{field:"description",header:"描述",sortable:""},{body:n(({data:s})=>[t("p",fe,f(s.description),1)]),_:1}),a(m,{field:"category",header:"分類",sortable:""},{body:n(({data:s})=>[t("span",null,f(s.category),1)]),_:1}),a(m,{field:"sortOrder",header:"排序",sortable:""},{body:n(({data:s})=>[t("span",null,f(s.sortOrder),1)]),_:1}),a(m,{field:"imageUrl",header:"封面圖片",sortable:""},{body:n(({data:s})=>[s.imageUrl?(C(),k("img",{key:0,src:s.imageUrl,alt:"封面",class:"w-20 h-12 object-cover rounded shadow cursor-pointer",onClick:_=>j(s)},null,8,be)):Z("",!0)]),_:1}),a(m,{field:"visible",header:"狀態",sortable:""},{body:n(({data:s})=>[t("div",ve,[a(g(M),{id:"visible",name:"visible",modelValue:s.visible,"onUpdate:modelValue":_=>I(s,_)},null,8,["modelValue","onUpdate:modelValue"]),a(R,{value:s.visible?"上架":"下架",severity:T(s.visible)},null,8,["value","severity"])])]),_:1}),a(m,{header:"操作",exportable:!1},{body:n(({data:s})=>[t("div",ye,[a(i,{icon:"pi pi-pencil",severity:"warning",text:"",size:"small",onClick:_=>q(s)},null,8,["onClick"])])]),_:1})]),_:1},8,["loading","value"])]),_:1}),a(F,{visible:u.value,"onUpdate:visible":e[10]||(e[10]=s=>u.value=s),header:c.value?"編輯模組":"新增模組",modal:"",class:"p-fluid w-[95vw] sm:w-[38rem] max-w-4xl",dismissableMask:!0,pt:{content:{class:"max-h-[70dvh] overflow-y-auto"},footer:{class:"mt-4 sm:mt-6 pt-4 border-t border-gray-200/80 bg-white sticky bottom-0"}}},{footer:n(()=>[t("div",Ce,[a(i,{label:"取消",icon:"pi pi-times",text:"",class:"!px-4 !py-2",onClick:e[9]||(e[9]=s=>u.value=!1),id:"cancelModuleButton"}),a(i,{label:c.value?"更新":"新增",icon:"pi pi-check",class:"!px-5 !py-2 !bg-indigo-600 hover:!bg-indigo-700 !border-indigo-600",onClick:B},null,8,["label"])])]),default:n(()=>[t("div",we,[t("div",xe,[t("div",_e,[e[13]||(e[13]=t("label",{for:"title",class:"block text-sm font-medium text-gray-700 mb-1"}," 標題（必填） ",-1)),a(r,{id:"title",name:"title",modelValue:o.title,"onUpdate:modelValue":e[3]||(e[3]=s=>o.title=s),modelModifiers:{trim:!0},maxlength:100,required:"",placeholder:"最多 100 字",class:"p-inputtext-sm text-sm w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},null,8,["modelValue"])]),t("div",null,[e[14]||(e[14]=t("label",{for:"category",class:"block text-sm font-medium text-gray-700 mb-1"},"分類（必填）",-1)),a(g($),{id:"category",name:"category",modelValue:o.category,"onUpdate:modelValue":e[4]||(e[4]=s=>o.category=s),options:P,optionLabel:"label",optionValue:"value",required:"",placeholder:"選擇分類",class:"w-full"},null,8,["modelValue"])]),t("div",null,[e[15]||(e[15]=t("label",{for:"sortOrder",class:"block text-sm font-medium text-gray-700 mb-1"},"排序 (1) 數字越小越前 (2) 0為首頁顯示",-1)),a(g(ae),{id:"sortOrder",name:"sortOrder",modelValue:o.sortOrder,"onUpdate:modelValue":e[5]||(e[5]=s=>o.sortOrder=s),min:0,class:"w-full [&_.p-inputnumber-input]:w-full [&_.p-inputnumber-input]:rounded-lg [&_.p-inputnumber-input]:border [&_.p-inputnumber-input]:border-gray-300 [&_.p-inputnumber-input]:text-sm [&_.p-inputnumber-input]:h-9 [&_.p-inputnumber-input:focus]:ring-2 [&_.p-inputnumber-input:focus]:ring-indigo-500 [&_.p-inputnumber-input:focus]:border-indigo-500"},null,8,["modelValue"])]),t("div",Ue,[e[16]||(e[16]=t("label",{for:"imageUrl",class:"flex items-center gap-2 text-sm font-medium text-gray-700 mb-1"},[t("span",null,"封面圖片網址（必填）"),t("i",{class:"pi pi-info-circle text-gray-500",title:"建議 1200×675（16:9）"})],-1)),a(r,{id:"imageUrl",name:"imageUrl",modelValue:o.imageUrl,"onUpdate:modelValue":e[6]||(e[6]=s=>o.imageUrl=s),modelModifiers:{trim:!0},type:"url",required:"",placeholder:"https://example.com/cover.jpg",class:"p-inputtext-sm text-sm w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},null,8,["modelValue"])]),t("div",Ve,[e[17]||(e[17]=t("label",{for:"description",class:"block text-sm font-medium text-gray-700 mb-1"},"描述（必填）",-1)),a(E,{id:"description",name:"description",modelValue:o.description,"onUpdate:modelValue":e[7]||(e[7]=s=>o.description=s),modelModifiers:{trim:!0},rows:"2",autoResize:"",maxlength:300,required:"",placeholder:"最多 300 字",class:"p-inputtext-sm text-sm w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},null,8,["modelValue"])]),t("div",he,[e[18]||(e[18]=t("label",{for:"visible",class:"block text-sm font-medium text-gray-700 mb-2"},"狀態（必填）",-1)),t("div",ke,[a(g(M),{id:"visible",name:"visible",modelValue:o.visible,"onUpdate:modelValue":e[8]||(e[8]=s=>o.visible=s)},null,8,["modelValue"]),t("span",{class:ee(["text-xs px-2 py-1 rounded-md",o.visible?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"])},f(o.visible?"上架":"下架"),3)])])])])]),_:1},8,["visible","header"]),a(N)])}}};typeof O=="function"&&O($e);export{$e as default};
